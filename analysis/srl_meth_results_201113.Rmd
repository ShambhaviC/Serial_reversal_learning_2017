---
title: "Serial Reversal Learning in wild nectar-feeding bats"
author: "Shambhavi"
output: html_document
fig_caption: yes
---
<style>
body {
text-align: justify}
</style>

## Study site and subjects
The experiment was done in June and July 2017 at La Selva Biological Field Station, Province Heredia, Costa Rica. Male and female individuals of the species *Glossophaga commissarisi* (**the questionable Garner reference**), were captured from the wild for the experiment at a few different in batches of 8 at a . The bats were attracted to a particular location in the forest using sugar-water (see **Reward** below) as bait and then caught in mist-nets. The bats were sexed and the selected individuals were were then taken to flight cages at another location in the rainforest. These were 4 x 6 m cabins with mesh walls, and thus with the same climactic conditions as the surrounding environment. The bats were weighed, radio frequency identification (RFID) tags were placed around their necks as collars (assigned uniquely to each bat) and released into the flight cages so they could fly within them freely. 4 bats at a time were put into a flight cage. These were called 'groups' and all the individuals in a group were the same sex. 

Before the start of the experiment the procedure was tested with 4 females or 'beta bats' and refinements were made. The data from these individuals were not analysed. Of the bats that participated in the main experiment, most completed it and a few did not. The bats were released back into the forest upon completing the experiment, or as soon as we noticed they were not consuming a sufficient number of calories to maintain a healthy weight (see **Supplementary Information - Table 1** for details). Prior to release the RFID collars were removed, the bats were weighed to ensure they had not lost too much weight (see **Supplementary Information - Table 1**) No blinding was done as all the data collection was completely automatized. 
Animal experimental procedures were reviewed and permission for animal experimentation and RFID-tagging was granted by Sistema Nacional de Areas de Conservación (SINAC) at the Ministerio de
Ambiente y Energía (MINAE) Costa Rica.

## Cage and feeder system
### Experimental Apparatus
Each flight cage had a square plastic frame in the center (2x2x1.5m). 8 reward-dispensing devices - hereafter referred to as 'flowers' - were fixed in a radial pattern on this frame, two on each side of the square (see Figure 1) with a minimum distance of 40 cm between adjacent flowers. This is known to be a distance discriminable by these bats (insert reference here - Winter and Stich?). Each flower had the following parts: 

* An RFID reader mounted on a plastic cylinder around the head of the flower 
* An infra-red light-barrier beam
* An electronic pinch valve through which a PVC tube was placed and fixed to the head of the flower

Nectar was pumped through the tubes to the flowers by a single stepper-motor syringe pump which was placed at the center of the plastic frame, and the flow was controlled by the pinch valves. When an RFID-tagged bat approached a flower, the individual RFID number was read by the reader. If the bat then poked its nose into the flower and broke the light barrier, it triggered the release of a reward: the pinch valve opened and the pump moved a pre-programmed number of steps to dispense the correct volume of nectar to the head of the flower. The bat could lick this up and then fly away. Only when both events occured, i.e., the RFID reader detected a bat and the light-barrier was broken, would a reward be triggered. 

The flowers were connected to a Lenovo ThinkPad laptop computer, which ran the experimental programs and the programs used to clean and fill the systems: PhenoSoft Control 16, PhenoSoft GmBH, Berlin, Germany. The raw data were also recorded to this computer as Comma-separated values (CSV) files. 

### Reward
The reward received by the bats during the experiment was also their main source of food. The reward was a 17% by weight solution of sugar dissolved in water (prepared fresh everyDay), hereafter referred to as 'nectar'. The sugar consisted of a 1:1:1 mass-mixture of sucrose, fructose and dextrose. The nectar was thus similar in composition and concentration to the nectar produced by wild chiropterophilous plants (Baker et al., 1998).

## Experimental procedure
Every Day at around 10 AM the old nectar was emptied from the system. The system was rinsed and filled with plain water until 3 PM in the afternoon, when it was filled again with fresh nectar. Twice a week the system was filled with 70% ethanol for an hour to guard against fungal growth, then repeatedly rinsed with water. 

Each bat was uniquely assigned 2 adjacent flowers on the same side of the square frame, out of the array of 8. These flowers were programmed to reward only 1 of the 4 bats in the cage. After the afternoon procedure of filling the system with fresh nectar was completed, 'test' visits were made to the flowers to ensure that they delivered rewards correctly. The program was then left running for the rest of the night for data-collection. Thus, the bats could begin visiting the flowers to collect a reward whenever they chose, which was usually around 6 PM in the evening. Every Day the bats were also given ad-libitum supplemental food:  3.5g of hummingbird food (NektarPlus, Nekton) in 100 mL of water and 3.5g of milk powder (Nido 1+, Nestle) in 100 mL of water. They were also given a small bowl of local bee pollen. 

## Experimental design
The experiment proceeded through the following stages. 

* Ad-lib reward

On the night the naive bats were captured and placed into the flight cages they received ad-libitum reward from all the flowers all night long. To enable the bats to find the flowers a small cotton pad soaked in dimethyl disulphide (a chemical attractant produced by many bat-pollinated flowers - von Helversen et al., 2000) was placed on the flowers. A small drop of honey was applied to the inside of the flowers to encourage the bats to place their heads inside, break the light-barrier and trigger a nectar reward. The bats nearly always found the flowers and learned to trigger rewards quickly. 

* Flower training

After the bats had learned to trigger rewards, the next stage of training involved assigning the bats uniquely to 2 out of the 8 flowers in the array. This stage was similar to Ad-libitum, except the bats could only trigger a reward at their assigned flowers. 

* Alternation

To ensure that the bats were familiar with both flowers assigned to them they went through one final stage of training: forced alternation between the two assigned flowers all night long. 
For all three training stages the bats received x $/mu$L of reward on every visit. 

* Main Experiment

In this serial reversal learning task the bats had to choose between a flower that gave 40 $/mu$L of nectar (S+) and one that gave no reward at all. The spatial locations of the two flowers served as the cues indicating which flower was more profitable. After a bat had made 50 visits in total to the two flowers a reversal occurred: the previously rewarding flower became the non-rewarding flower and vice versa. This occurred at regular intervals of 50 visits until the bat either stopped making visits or reached a maximum of 300 visits in a night. After the bat had made 300 rewarded visits it could no longer receive a reward that experimental night. There were 5 reversals per night. This stage of the experiment was repeated for 3 nights in a row. 

## Analysis 

This bit to be written a little later. 

## Mathematical modeling

This bit to be written a little later. 

# Results
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center")
```

```{r, include = FALSE}
# clearing the environment
rm(list = ls())

# creating a vector of the required packages 

packages <- c("rmarkdown", "reshape2", "knitr", "kableExtra", "scales", "caTools", "tidyverse", "ggpubr", "lubridate",  "Hmisc", "rstanarm")

# loading the required packages 
lapply(packages, library, character.only = TRUE)

#install.lib <- packages[!packages %in% installed.packages(lib.loc = NULL)]
#for (lib in install.lib) install.packages(lib, dependencies = TRUE)
#sapply(packages, require, character = TRUE)

```
## Preference for the rewarding option
The bats' individual choices for the S+ are shown in Figure 1. There appears to be a great deal of individual variation in the animals' behaviour, from near-perfect adherence to the 'win-stay, lose-shift' strategy on some days to repeated visits to the unrewarding option on others. 
```{r}
#----------------------------------------
# Preparing data from the main experiment
#----------------------------------------
# loading the prepared CSV file of raw data
raw_data <- read.csv2(file = "data/raw_data.csv", sep = ";", header = TRUE)

# The following terms are used in the analysis of the data:
# 1. visits: each individual flower visit
# 2. block: a group of 50 visits between each reversal where the same flower is rewarding
# 3. bin: a smaller group of visits within a block, the size of which can be set in the code below

# creating a vector of the bats to be excluded from the main analysis

# creating a vector of the bats to be excluded from the main analysis
bats_incomp <- c("Bat7", "Bat19")

# creating a vector of the main experimental Days
main_days <- c("Day 1", "Day 2", "Day 3")

# setting binsize and breaks for cutting up the data into block and bins
binsize <- 10
breaks <- seq(0, 3000, binsize)

# preparing the data from the main experiment in a data table
rev_learning_all <- raw_data %>%
  mutate(
    # marking the difference between the normal visits in a block and the switch points
    MsgValue1 = ifelse(MsgValue1 == "switch", MsgValue1, "block")
  ) %>%
  filter(
    # removing the bats that did not complete the experiment
    !IdLabel %in% bats_incomp,
    # filtering out the main experimental data
    Condition == "SerialReversalCounter"
  ) %>%
  rename(Bat = IdLabel) %>%
  arrange(Group, Day, Bat, DateTime) %>%
  # grouping the data to count the visits, noting the reversals separately
  group_by(Bat, Day) %>%
  mutate(
    # noting whether the bat made a visit to the more or less rewarding flower
    reward_status = ifelse(is.na(reinforce1value), 0, 1),
    # creating a column with the total number of visits made by a bat per Day
    count_vis = ifelse(MsgValue1 == "switch", 0, 1),
    count_vis = cumsum(count_vis)
  ) %>%
  # setting the maximum number of visits a night
  filter(count_vis <= 300) %>%
  ungroup() %>%
  # creating a column with the reversal block number, marking the reversals
  mutate(block = ifelse(MsgValue1 == "switch", 1, 0)) %>%
  group_by(Day, Bat) %>%
  mutate(block = cumsum(block)) %>%
  ungroup() %>%
  group_by(Day, Bat, block) %>%
  # creating a column with the number of visits within each block
  mutate(
    block_vis = ifelse(MsgValue1 == "switch", 0, 1),
    block_vis = cumsum(block_vis)
    # creating a new column for visits in each block to be binned
  ) %>%
  ungroup() %>%
  group_by(Day, Bat, block) %>%
  # cutting the visits inside each block into bins of the size set earlier
  mutate(bins = as.numeric(cut(block_vis, breaks, include.lowest = TRUE)))

# creating a vector with the beta bats

bats_beta <- c("Bat1", "Bat2", "Bat3", "Bat4")

# creating a data frame with just the beta bats
rev_learning_beta <- rev_learning_all %>%
  filter(Bat %in% bats_beta)

# creating a data frame with the alpha bats and the three main Days of the experiment
rev_learning_ind <- rev_learning_all %>%
  filter(!Bat %in% bats_beta)

# averaging the bats' performance over Day, block and bin

rev_learning_avg <- rev_learning_ind %>%
  group_by(Day, block, bins) %>%
  # calculating the 95% confidence intervals
  group_modify(~ mean_cl_boot(.x$reward_status, conf.int = 0.95)) %>%
  ungroup() %>%
  group_by(Day) %>%
  mutate(
    Day_bin = 1:n(),
    Day_bin_vis = Day_bin * binsize,
    reversal = ifelse(block != lead(block), "switch", "block")
  )

# calculating the bats' 'errors', i.e., the inverse of the previous calculation, and averaging
# over Day, block and bin

rev_learning_err <- rev_learning_ind %>%
  mutate(error = 1 - (reward_status)) %>%
  group_by(Day, block, bins) %>%
  # calculating the 95% confidence intervals
  group_modify(~ mean_cl_boot(.x$error, conf.int = 0.95)) %>%
  ungroup() %>%
  group_by(Day) %>%
  mutate(
    Day_bin = 1:n(),
    Day_bin_vis = Day_bin * binsize,
    reversal = ifelse(block != lead(block), "switch", "block")
  )
```

```{r, fig.cap="Figure 1: All individual choices of the bats for the rewarding and non-rewarding options", fig.width = 12, fig.height = 7}
#--------------
# Summary plots
#--------------

# plot 1: plotting the individual bats' choices for the profitable option for every visit

# creating a look-up table so the reversals can be marked in the plots for the main experimental bats
rev_main <- rev_learning_ind %>%
  filter(
    MsgValue1 == "switch",
    Day %in% main_days
  ) %>%
  select(Day, Bat, count_vis, block, bins, MsgValue1)

rev_learning_ind %>%
  filter(Day %in% main_days) %>%
  ggplot(aes(count_vis, reward_status)) +
  geom_line() +
  facet_grid(Bat ~ Day) +
  geom_vline(aes(xintercept = count_vis), rev_main, colour = "red") +
  ylab("Choice for the rewarding option") +
  xlab("Visits") +
  theme_classic()
```
The average preference of the bats for the rewarding option and the non-rewarding option are shown in Figures 2a and 2b respectively. Overall, it appears the bats discriminate between the two options with a high rate of success in choosing the S + and continue to do with each successive reversal. 
```{r, fig.cap = "Figure 2: a) Average preferences of the bats for the rewarding option; b) Average preferences of the bats for the less rewarding option - the 'errors'", fig.width = 12, fig.height = 3}

# plot 2a: averaging the bats' preferences over Day, block and bin
# creating a look-up table for the reversals

rev_main_avg <- rev_learning_avg %>%
  filter(
    reversal == "switch",
    Day %in% main_days
  ) %>%
  select(Day, block, Day_bin, Day_bin_vis)

p1 <- rev_learning_avg %>%
  # filtering only the first three main Days of the experiment:
  # one group had the experiment extended a further three Days
  filter(Day %in% main_days) %>%
  # mutate(visits = bins * 10) %>%
  ggplot(aes(Day_bin_vis, y)) +
  geom_point() +
  geom_line() +
  geom_ribbon(aes(ymin = ymin, ymax = ymax), alpha = 0.3) +
  facet_grid(. ~ Day) +
  scale_x_continuous(breaks = seq(50, 300, by = 50)) +
  ylim(0, 1.05) +
  geom_hline(yintercept = c(0.25, 0.5, 0.75, 1), linetype = "dotted") +
  geom_vline(aes(xintercept = Day_bin_vis), rev_main_avg, linetype = "dashed") +
  theme_classic() +
  labs(x = "Visits", y = "Avg choice for the rewarding option \n ± 95% CIs") +
  ggtitle("a)") 
  #annotate(geom = "text", x = 0, y = 1.04, label = "a)", size = 4)

# plot 2b: plotting the individual bats' choices for the less profitable option, the inverse of plot 1

rev_main_err <- rev_learning_err %>%
  filter(
    reversal == "switch",
    Day %in% main_days
  ) %>%
  select(Day, block, Day_bin, Day_bin_vis)

p2 <- rev_learning_err %>%
  # filtering only the first three main Days of the experiment:
  # one group had the experiment extended a further three Days
  filter(Day %in% main_days) %>%
  ggplot(aes(Day_bin_vis, y)) +
  geom_point() +
  geom_line() +
  geom_ribbon(aes(ymin = ymin, ymax = ymax), alpha = 0.3) +
  facet_grid(. ~ Day) +
  scale_x_continuous(breaks = seq(50, 300, by = 50)) +
  ylim(0, 1.05) +
  geom_hline(yintercept = c(0.25, 0.5, 0.75, 1), linetype = "dotted") +
  geom_vline(aes(xintercept = Day_bin_vis), rev_main_avg, linetype = "dashed") +
  theme_classic() +
  labs(x = "Visits", y = "Avg choice for the non-rewarding option \n ± 95% CIs") +
  ggtitle("b)") 
 # annotate(geom = "text", x = 0, y = 1.04, label = "b)", size = 4)

ggarrange(p1, p2, ncol = 2, nrow = 1)
```

## The effect of serial reversals on choice behaviour
The fixed effect bins significantly influenced the preference of the bats, as did the interaction of reversal block with bin, but the fixed effects day and block and their interactions did not (see Table 1). The bats' choice for the rewarding option increased within each reversal block, from a high number of choices for the S- in the bin immediately after the reversal to near 100% preference for the S+ as the reversal block progressed. However, their preference for the S+ within each block decreased as they experienced successive blocks. 
```{r message = FALSE, warning = FALSE, message = FALSE, echo=FALSE, results='hide'}
#--------------------------------------------------
# Fitting a Bayesian generalized linear mixed model
#--------------------------------------------------

rev_learning_stat <- rev_learning_ind %>%
ungroup() %>%
  filter(Day %in% main_days) %>%
  mutate(
    Day = ifelse(Day == "Day 1", 1, ifelse(Day == "Day 2", 2, 3)),
    bins = bins %% 5,
    bins = ifelse(bins == 0, 5, bins)
  ) %>%
  group_by(Bat, Day, block, bins) %>%
  summarise(avg_prof = mean(reward_status))

prof <- stan_glmer(avg_prof ~ (1 | Bat) + Day + block + bins + Day * block + block * bins,
  data = rev_learning_stat,
  family = binomial
)

```

```{r message = FALSE, warning = FALSE, message = FALSE, echo=FALSE, results='asis'}

summary_prof <- as.data.frame(summary(prof, probs = c(0.025, 0.5, 0.975), digits = 3)) %>%
  filter(row_number() < 7) %>%
  select(5, 4, 6) %>%
  rename(Estimate = 1)

kable(summary_prof, align = "l", padding = 0, caption = "Table 1: Results of the Bayesian Generalized Linear Mixed Model testing for the effect of Day, block, bin (fixed effects) and Individual (random effect) on choice for the S+ (dependent variable)") %>%
  kable_styling(position = "center", full_width = F)
```

# Supplementary Information 

**Table S1 - Summary of characteristics of bats that completed in the experiment**
```{r, results='asis'}

table1 <- data.frame(
  Individual = c("Bat5", "Bat6", "Bat8", "Bat9", "Bat10", "Bat11", "Bat12", "Bat13", "Bat14", "Bat15", "Bat16", "Bat17", "Bat18", "Bat20"),
  Sex = rep(c("Female", "Male"), 1, each = 7),
  `Flight cage` = c(rep(2, 3), rep(c(1, 2), 1, each = 4), rep(1, 3)),
  # how do you insert spaces into column names?
  `Weight on capture [g]` = c(9, 8.5, 8.5, 8.5, 8.5, 9, 10, 8.5, 9, 9.5, 10, 10, 10.5, 9.5),
  `Weight on release [g]` = c(8.5, 8.5, 8.5, 8, 8, 8.5, 9, 8, 8, 8, 9.5, 8, 8.5, 8.5),
  check.names = FALSE
)
kable(table1, align = "c", padding = 0) %>%
  kable_styling(position = "center", full_width = F)
```
**Figure 1 - Performance in the training stages **

Do we need this here? 

**Figure 2 - Inter-visit intervals** 
```{r, fig.cap="Figure S2: Distribution of inter-visit intervals [s]"}
#-----------------------
# Inter-visit intervals
#-----------------------
# calculating the inter-visit intervals of all the bats 

rev_learning_ivi <- rev_learning_ind %>%
  group_by(Day, Bat) %>%
  mutate(interval = as.integer(difftime(lead(DateTime), DateTime, units = "secs")))

rev_learning_ivi %>%
  filter(Day %in% main_days) %>%
  ggplot(aes(interval, group = Bat)) +
  geom_density(fill = "black", color = "transparent", alpha = 0.08) +
  facet_grid(. ~ Day) +
  scale_x_log10() +
  theme_bw() +
  xlab("intervisit intervals [s]") +
  scale_fill_viridis_d()
```