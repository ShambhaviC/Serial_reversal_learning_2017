---
title: "Serial Reversal Learning in wild nectar-feeding bats - Draft 1"
author: "Shambhavi"
output: html_document
fig_caption: yes
---
<style>
body {
text-align: justify}
</style>

```{r global_options, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
# clearing the environment
rm(list = ls())

# checking if rmarkdown and reshape2 are installed, and installing them if they are not 
if(!require(rmarkdown)){install.packages('rmarkdown')}
library(rmarkdown)
if(!require(reshape2)){install.packages('reshape2')}
library(reshape2)
```
```{r, setup, include=FALSE}
# knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, include=TRUE)
# setting the working directory just once
knitr::opts_knit$set(root.dir = "/Users/shambhavi/Google Drive/Experiments & Data/Reversal Learning - La Selva_2017/Analysis/Analysis/Raw Data")

```

# Introduction 

# Materials and Methods

## Study site and subjects
The experiment was done in June and July 2017 at La Selva Biological Field Station, Province Heredia, Costa Rica. Male and female individuals of the species *Glossophaga commissarisi* (**the questionable Garner reference**), were captured from the wild for the experiment at a few different in batches of 8 at a . The bats were attracted to a particular location in the forest using sugar-water (see **Reward** below) as bait and then caught in mist-nets. The bats were sexed and the selected individuals were were then taken to flight cages at another location in the rainforest. These were 4 x 6 m cabins with mesh walls, and thus with the same climactic conditions as the surrounding environment. The bats were weighed, radio frequency identification (RFID) tags were placed around their necks as collars (assigned uniquely to each bat) and released into the flight cages so they could fly within them freely. 4 bats at a time were put into a flight cage. These were called 'groups' and all the individuals in a group were the same sex. 

Before the start of the experiment the procedure was tested with 4 females or 'beta bats' and refinements were made. The data from these individuals were not analysed. Of the bats that participated in the main experiment, most completed it and a few did not. The bats were released back into the forest upon completing the experiment, or as soon as we noticed they were not consuming a sufficient number of calories to maintain a healthy weight (see **Supplementary Information - Table 1** for details). Prior to release the RFID collars were removed, the bats were weighed and a small part of the hair on their backs was clipped to indicate that these individuals had participated in the experiment in case they were caught in the mist-nets again. (**are we allowed to mention this?**) No blinding was done as all the data collection was completely automatized. 
Animal experimental procedures were reviewed and permission for animal experimentation and RFID-tagging was granted by Sistema Nacional de Areas de Conservación (SINAC) at the Ministerio de
Ambiente y Energía (MINAE) Costa Rica.

## Cage and feeder system
### Reward
The reward received by the bats during the experiment was also their main source of food. The reward was a 17% by weight solution of sugar dissolved in water (prepared fresh everyday), hereafter referred to as 'nectar'. The sugar consisted of a 1:1:1 mass-mixture of sucrose, fructose and dextrose. The nectar was thus similar in composition and concentration to the nectar produced by wild chiropterophilous plants (Baker et al., 1998).

### Experimental Apparatus
Each flight cage had a square plastic frame in the center (2x2x1.5m). 8 reward-dispensing devices - hereafter referred to as 'flowers' - were fixed in a radial pattern on this frame, two on each side of the square (see Figure 1) with a minimum distance of 40 cm between adjacent flowers. This is known to be a distance discriminable by these bats (insert reference here - Winter and Stich?). Each flower had the following parts: 

* An RFID reader mounted on a plastic cylinder around the head of the flower 
* An infra-red light-barrier beam
* An electronic pinch valve through which a PVC tube was placed and fixed to the head of the flower

Nectar was pumped through the tubes to the flowers by a single stepper-motor syringe pump which was placed at the center of the plastic frame, and the flow was controlled by the pinch valves. When an RFID-tagged bat approached a flower, the individual RFID number was read by the reader. If the bat then poked its nose into the flower and broke the light barrier, it triggered the release of a reward: the pinch valve opened and the pump moved a pre-programmed number of steps to dispense the correct volume of nectar to the head of the flower. The bat could lick this up and then fly away. The bats had to hover to trigger and collect a reward, and could not sit on the flowers. 

The flowers were connected to a Lenovo ThinkPad laptop computer, which ran the experimental program: PhenoSoft Control 16, PhenoSoft GmBH, Berlin, Germany. The raw data were also recorded to this computer as Comma-separated values (CSV) files. 

## Experimental design and schedule
Each bat was uniquely assigned 2 adjacent flowers on the same side of the square frame, out of the array of 8. These flowers were programmed to reward only 1 of the 4 bats in the cage. Data collection was done between 6 PM and 6 AM, when the experimental program ran. In the morning the old nectar was emptied from the system, and then the system was rinsed and filled with plain water until 3 PM in the afternoon, when it was filled with fresh nectar. Twice a week the system was filled with 70% ethanol for an hour to guard against fungal growth. Every day the bats were also given ad-libitum supplemental food:  3.5g of hummingbird food (NektarPlus, Nekton) in 100 mL of water and 3.5g of milk powder (Nido 1+, Nestle) in 100 mL of water. They were also given a small bowl of local bee-collected pollen. 

The experiment proceeded through the following stages. 

### Ad-lib reward
On the night the naive bats were captured and placed into the flight cages they received ad-libitum reward from all the flowers all night long. To enable the bats to find the flowers a small cotton pad soaked in dimethyl disulphide (a chemical attractant produced by many bat-pollinated flowers - von Helversen et al., 2000) was placed on the flowers. A small drop of honey was applied to the inside of the flowers to encourage the bats to place their heads inside, break the light-barrier and trigger a nectar reward. The bats nearly always found the flowers and learned to trigger rewards quickly. 

### Flower training
After the bats had learned to trigger rewards, the next stage of training involved assigning the bats uniquely to 2 out of the 8 flowers in the array. This stage was similar to Ad-libitum, except the bats could only trigger a reward at their assigned flowers. 

### Alternation
To ensure that the bats were familiar with both flowers assigned to them they went through one final stage of training: forced alternation between the two assigned flowers all night long. 
For all three training stages the bats received x $/mu$L of reward on every visit. 

### Main Experiment
In this serial reversal learning task the bats had to choose between a flower that gave 40 $/mu$L of nectar (S+) and one that gave 10 $/mu$L of nectar (S-). The spatial locations of the two flowers served as the cues indicating which flower was more profitable. After a bat had made 50 visits in total to the two flowers a reversal occurred: the previously less rewarding flower became the more rewarding flower and vice versa. This occurred at regular intervals of 50 visits until the bat either stopped making visits or reached a maximum of 300 visits in a night. Thus there were 5 reversals per night. At that point no more rewards were given to that particular bat. This stage of the experiment was repeated for 3 nights in a row to see the effect of day on the animals' performance. 

## Analysis 
This bit to be written a little later. 

## Mathematical modeling


# Results and summary figures

```{r echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
# checking to see if the required packages are installed and install them if they are not
if(!require(tidyverse)){install.packages('tidyverse')}
library(tidyverse)
if(!require(scales)){install.packages('scales')}
library(scales)
if(!require(lubridate)){install.packages('lubridate')}
library(lubridate)
if(!require(stringr)){install.packages('stringr')}
library(stringr)
if(!require(caTools)){install.packages('caTools')}
library(caTools)
if(!require(mgcv)){install.packages('mgcv')}
library(mgcv)
if(!require(gridExtra)){install.packages('gridExtra')} 
library(gridExtra) 

setwd("/Users/shambhavi/Google Drive/Experiments & Data/Reversal Learning - La Selva_2017/Analysis/Analysis/Raw Data")
getwd()
raw_data <- read.csv2("Raw_data.csv", sep = ";", header = TRUE)

# The following terms are used in the analysis of the data:
# 1. visits: each individual flower visit
# 2. trials: a group of 3 consecutive visits
# 3. block: a group of 50 visits between each reversal where the same flower is rewarding

# creating a vector of the bats to be excluded from the main analysis

bats_incomp <- c("Bat7", "Bat19")

# creating a vector of the main experimental days

main_days <- c("Day 1", "Day 2", "Day 3")

# setting binsize and breaks for cutting up the data into blocks and bins

bins <- 10
breaks <- seq(0, 3000, bins) # function needed for this to plot the plots with proper X-axis ticks

# preparing the data from the main experiment in a data table

rev_learning_all <- raw_data %>%
  mutate(
  Hour = hour(DateTime), 
  MsgValue1 = ifelse(MsgValue1 == "switch", MsgValue1, "block")
  ) %>%
  # filtering and removing the non-experimental times
  filter(
    # removing the bats that did not complete the experiment
    !IdLabel %in% bats_incomp,
    # filtering out the main experimental data
    Condition == "SerialReversalCounter", 
    Hour >= 18 | Hour < 6
  ) %>%
  select(-Hour) %>% 
  # marking the timepoints where the reversals happened
  rename(Bat = IdLabel) %>%
  arrange(Group, day, Bat, DateTime) %>%
  # grouping the data to count the visits, noting the reversals separately
  group_by(Bat, day, MsgValue1) %>%
  mutate(
    # noting whether the bat made a visit to the more or less rewarding flower
    reward_status = ifelse(is.na(reinforce1value), 0, 1),
    count_vis = 1:n() 
  ) %>%
  filter(count_vis <= 300) %>% 
  ungroup() %>%
  mutate(blocks = ifelse(MsgValue1 == "switch", 1, 0)) %>% 
  group_by(day, Bat) %>%
  mutate(blocks = cumsum(blocks) + 1, 
         count_vis = ifelse(MsgValue1 == "switch", lead(count_vis), count_vis)) %>% 
  group_by(day, Bat, blocks) %>% 
  mutate(block_vis = 1:n()) %>% 
  ungroup() %>%  
  mutate(bins = "") %>% 
  ungroup() %>% 
  group_by(day, Bat, blocks) %>%
  mutate(bins = as.numeric(cut(block_vis,breaks,include.lowest=TRUE))) 

# creating a vector with the beta bats

bats_beta <- c("Bat1", "Bat2", "Bat3", "Bat4")

# creating a data frame without the beta bats with the data from the individual bats 
rev_learning_ind <- rev_learning_all %>%
  filter(!Bat %in% bats_beta)

# creating a look-up table so the reversals can be marked in the plots for the alpha bats 
rev_ind <- rev_learning_ind %>% 
  filter(MsgValue1 == "switch", 
         day %in% main_days) %>% 
  select(day, Bat, count_vis, blocks, bins, MsgValue1)

# creating a separate dataframe with preferences averaged over all the bats and the 95% CIs
rev_learning_avg <- rev_learning_ind %>%   
  group_by(day, blocks, bins) %>%
  group_modify(~ mean_cl_boot(.x$reward_status, conf.int = 0.95)) %>%
  ungroup() %>% 
  group_by(day) %>%
  mutate(bin_count = 1:n())

# creating a look-up table to mark the reversals for the averaged data 
rev_avg <- rev_learning_avg %>% 
  filter(day %in% main_days) %>% 
  group_by(day, blocks) %>% 
  summarise(rev = max(bin_count)) 
```

Blah blah blah 

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.cap = "Figure 1a: Individual differences in preferences Figure 1b: Preference for the more profitable flower averaged over individuals", fig.width = 14, fig.height = 7}
  
# plot 1: plotting the individual bats' choices for the profitable option, averaged
# over the number of visits that go into a bin (see the variable binsize)
rev_learning_ind %>% 
  filter(day %in% main_days) %>% 
  ggplot(aes(count_vis, reward_status)) +
  geom_line() +
  facet_grid(Bat~day) +
  geom_vline(aes(xintercept = count_vis), rev_ind, colour = "red") + 
  ylab("Choice for the more profitable option") + 
  xlab("Visits") + 
  theme_classic()

```
```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.cap = "Figure 1b: Preference for the more profitable flower averaged over individuals", fig.width = 14, fig.height = 7}
# plot 2: plotting the preferences of the bats averaged over individuals
p2 <- rev_learning_avg %>%
  # filtering only the first three main days of the experiment:
  # one group had the experiment extended a further three days
  filter(day %in% main_days) %>%
  ggplot(aes(bin_count, y)) +
  geom_point() +
  geom_line() +
  geom_ribbon(aes(ymin = ymin, ymax = ymax), alpha = 0.3) +
  facet_grid(. ~ day) +
  #scale_x_continuous(breaks = seq(50, 300, by = 50)) +
  ylim(0, 1.02) +
  geom_hline(yintercept = c(0.25, 0.5, 0.75, 1), linetype = "dotted") +
  geom_vline(aes(xintercept = rev), rev_avg, linetype = "dashed") +
  theme_classic() +
  labs(x = "Visits", y = "Avg choice for the more profitable option ± 95% CIs")

```

## 2. Individual differences in preference 

## 3. Anticipation and perseveration errors

## 4. Memory and anticipation

# Supplementary Information 

**Table 1 - Summary of characteristics of bats that participated in the experiment**
```{r message = FALSE, warning = FALSE, message = FALSE, echo=FALSE, results='asis'}
if(!require(knitr)){install.packages('knitr')}
library(knitr)
if(!require(kableExtra)){install.packages('kableExtra')}
library(kableExtra)

#table1 <- data.frame(Individual = #c("Bat1","Bat2","Bat3","Bat4","Bat5","Bat6","Bat7","Bat8","Bat9","Bat10","Bat11","Bat12","Bat13","Ba#t14","Bat15","Bat16","Bat17","Bat18","Bat19","Bat20"), 
#                     Sex = c("Female","Female","Female","Female","Female"), 
 #                    Flightcage = c(), 
  #                   Status = c("Excluded: did not participate in the experiment", "Completed", #"Completed", "Completed", "Excluded: poor health", "Completed", "Completed"))
#kable(table1, align = 'l', padding = 0, caption = "Males") %>%
#    kable_styling(position = "left", full_width = F)
```

**Figure 1 - Performance in the training stages ** 
** Figure 2 - Inter-visit intervals ** 

